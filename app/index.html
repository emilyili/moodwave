<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MoodWaves</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Open+Sans" rel="stylesheet">
</head>

<body>
  <div id='container'>
    <svg id="svg" height=200 width=90%></svg>
  </div>
  <script src="https://d3js.org/d3.v6.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- <script src="app.js" type="text/javascript"></script> -->
  <script src="data.js" type="text/javascript"></script>

</body>

</html>

<script>

  var d3 = d3;

var username = (window.prompt("Enter your username: "))
  var name = username.toLowerCase().replace(/\s/g, '').replace('-', '_');

// var name = "carafo_"
// var username = "carafo_"
  const margin = 40;
  const width = (screen.availWidth * 0.8) - 2 * margin
  // const width = 1200 - 2 * margin
  const height = 800 - 2 * margin

  var svg = d3.select('svg')
  var svgContainer = d3.select('#container')

  if(window[name] == undefined){
    alert("This username does not exist! Please try again.");
    window.location.reload();
  }

  var dataset = window[name].sort(function(a,b) {
    return a.date - b.date;
  })

  //circle chart
  var pie = d3.pie()
  var circ = pie([1, 1, 1, 1])
  var arcOut = d3.arc()
    .innerRadius(30)
    .outerRadius(60)

  var arcIn = d3.arc()
    .innerRadius(5)
    .outerRadius(30)

  var colorScaleOut = ["#B459DE", "#61ECDB", "#3372D2", "#FD3A3E"]
  var colorScaleIn = ["#E0BCF0", "#B6F6EE", "#B0C8ED", "#FED2D2"]

  var chart = svg.append("g")

  var legend = chart.append("g")

  legend.append("circle")
    .attr("cx", 100)
    .attr("cy", 200)
    .attr("r", 5)
    .attr("fill", "white")

  legend.selectAll("path")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,200)")
    .attr("d", arcIn)
    .attr("fill", function (d) {
      return colorScaleIn[d.index];
    })

  legend.selectAll("path2")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,200)")
    .attr("d", arcOut)
    .attr("fill", function (d) {
      return colorScaleOut[d.index];
    })

  //legend descriptions
  var tgrp = legend.append("g")
  tgrp.append("text")
    .attr("x", 0)
    .attr("y", 85)
    .attr("class", "title")
    .text("Mood Waves")
tgrp.append("text")
    .attr("x", width - (username.length * 2))
    .attr("y", 85)
    .attr("class", "heading")
    .text("Welcome, " + username)
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 300)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#FD3A3E")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 310)
    .attr("class", "subheading")
    .text("tense, nervous,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 335)
    .attr("class", "subheading")
    .text("stressed, upset")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 375)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#B459DE")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 385)
    .attr("class", "subheading")
    .text("alert, excited,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 410)
    .attr("class", "subheading")
    .text("elated, happy")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 450)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#61ECDB")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 460)
    .attr("class", "subheading")
    .text("content, serene,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 485)
    .attr("class", "subheading")
    .text("relaxed, calm")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 525)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#3372D2")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 535)
    .attr("class", "subheading")
    .text("tired, bored,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 560)
    .attr("class", "subheading")
    .text("depressed, sad")

  var x = d3.scaleBand()
    .domain(d3.range(dataset.length))
    .range([margin + 200, width - (margin - 50)])
    .padding(0.1)

  var y = d3.scaleLinear()
    .domain([0, d3.max(dataset, d => d.frequency)]).nice()
    .range([height - margin, margin + 40])

  var xAxis = g => g
    .attr("transform", `translate(0,${height - margin})`)
    .attr("color", "white")
    .call(d3.axisBottom(x).tickFormat(i => d3.timeFormat('%B')(new Date(dataset[i].date))).tickSizeOuter(0))

  var bars = chart.append('g')

    bars.selectAll("bars")
      .data(dataset)
      .enter()
      .append("rect")
      .join("rect")
    .attr("fill", function (d) {
      if (d.quadrant == 1)
        return "#B459DE";
      if (d.quadrant == 2)
        return "#61ECDB";
      if (d.quadrant == 3)
        return "#3372D2";
      if (d.quadrant == 4)
        return "#FD3A3E";
      if (d.quadrant == 5)
        return "#E0BCF0";
      if (d.quadrant == 6)
        return "#B6F6EE";
      if (d.quadrant == 7)
        return "#B0C8ED";
      if (d.quadrant == 8)
        return "#FED2D2";
      if (d.quadrant == 9)
        return "white";
    })
    .attr("x", (d, i) => x(i))
    .attr("y", d => ((y(d.frequency * 2) + height) / 5) + 100)
    .attr("height", d => (y(0) - y(d.frequency)) * 0.8)
    .attr("width", x.bandwidth() + 1)

    //hover capabilities
    .on("mouseover", function (d, i) {
      d3.select(this)
        .attr("opacity", "25%")

      var tooltip = bars.append("g")
          .attr("id", "tooltip")

        //  tooltip.append("rect")
        //     .attr("x", width)
        //     .attr("y", 100)
        //     .attr("width", "250px")
        //     .attr("height", "90%")
        //     .attr("fill", "#34383A")

           //circle chart
          //  tooltip.append("circle")
          //     .attr("cx", 100)
          //     .attr("cy", 200)
          //     .attr("r", 5)
          //     .attr("fill", "white")

          //     tooltip.selectAll("path3")
          //     .data(circ)
          //     .enter()
          //     .append("path")
          //     .attr("transform", "translate(100,200)")
          //     .attr("d", arcIn)
          //     .attr("fill", function(d) {
          //       return colorScaleIn[d.index];
          //     })

          //     tooltip.selectAll("path4")
          //     .data(circ)
          //     .enter()
          //     .append("path")
          //     .attr("transform", "translate(100,200)")
          //     .attr("d", arcOut)
          //     .attr("fill", function(d) {
          //       return colorScaleOut[d.index];
          //     })

         var date = new Date(i.date)

          //details
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 310)
            .attr("class", "heading")
            .text(`${date.toLocaleString('default', { month: 'short' })}` + " " + `${date.getDate()}` + ", " + `${date.getFullYear()}`)
          tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 335)
            .attr("class", "subbody")
            .text("You listened to " + `${i.frequency}` + " songs.")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 370)
            .attr("class", "subheading")
            .text("top songs")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 390)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[0].name.length <= 35) {
                return `${i.topsongs[0].name}`;
              } else {
                return `${i.topsongs[0].name}`.slice(0,35) + "...";
              }})
         tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 405)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[0].singer.length <= 35) {
                return `${i.topsongs[0].singer}`;
              } else {
                return `${i.topsongs[0].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 425)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[1].name.length < 35) {
                return `${i.topsongs[1].name}`;
              } else {
                return `${i.topsongs[1].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 440)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[1].singer.length <= 35) {
                return `${i.topsongs[1].singer}`;
              } else {
                return `${i.topsongs[1].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 460)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[2].name.length < 35) {
                return `${i.topsongs[2].name}`;
              } else {
                return `${i.topsongs[2].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 475)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[2].singer.length <= 35) {
                return `${i.topsongs[2].singer}`;
              } else {
                return `${i.topsongs[2].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 495)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[3].name.length < 35) {
                return `${i.topsongs[3].name}`;
              } else {
                return `${i.topsongs[3].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 510)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[3].singer.length <= 35) {
                return `${i.topsongs[3].singer}`;
              } else {
                return `${i.topsongs[3].singer}`.slice(0,35) + "...";
              }})
             tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 530)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[4].name.length < 35) {
                return `${i.topsongs[4].name}`;
              } else {
                return `${i.topsongs[4].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 545)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[4].singer.length <= 35) {
                return `${i.topsongs[4].singer}`;
              } else {
                return `${i.topsongs[4].singer}`.slice(0,35) + "...";
            }})
            tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 580)
            .attr("class", "subheading")
            .text("mood")
            tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 600)
            .attr("class", "subbody")
            .text(function() {
               if(i.keywords == null) {
                return "____";
              } else if(i.keywords.length <= 40) {
                return `${i.keywords}`;
              } else {
                return `${i.keywords}`.slice(0,40) + "...";
              }})
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 640)
            .attr("class", "subheading")
            .text("reflections")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 660)
            .attr("class", "subbody")
            .text(function() {
              if(i.reflections == null) {
                return "____";
              } else {
                return `${i.reflections}`;
            }})
            .attr("dy", 0)
            .call(wrap, x.bandwidth());
  			 })
  			.on("mouseout", function(d) {
  			  d3.select(this)
  			  .transition().duration(250)
  			  .attr("opacity", "100%");
  			  d3.select("#tooltip").remove();
  			});

  //x axis formatting
  var temp = []
  var axis = chart.append('g')

  axis.append("g")
    .call(xAxis)
    .selectAll(".tick text")
    .attr("fill", "white")
    .data(dataset)
    .each(function (d) {
      var date = new Date(d.date)
      if (temp[date.toLocaleString('default', { month: 'long' })] == undefined) {
        temp[date.toLocaleString('default', { month: 'long' })] = 1;
        return date.toLocaleString('default', { month: 'long' });
      } else {
        return d3.select(this).remove();
      }
    })

  function wrap(text) {
    text.each(function () {
      var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", width+50).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > 250) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", width+50).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }

  function classifyQuadrant(x, y) {
    if (x >= 0 && y > 0) {
      if (innerQuad(x, y)) {
        return 5;
      } else {
        return 1;
      }
    }
    else if (x > 0 && y <= 0) {
      if (innerQuad(x, y)) {
        return 6;
      } else {
        return 2;
      }
    }
    else if (x <= 0 && y < 0) {
      if (innerQuad(x, y)) {
        return 7;
      } else {
        return 3;
      }
    }
    else if (x < 0 && y >= 0) {
      if (innerQuad(x, y)) {
        return 8;
      } else {
        return 4;
      }
    }
    else {
      return 9;
    }
  }

  function innerQuad(x, y) {
    return Math.sqrt(x * x + y * y) < 3;
  }

</script>
