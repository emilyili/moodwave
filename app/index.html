<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MoodWaves</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Open+Sans" rel="stylesheet">
</head>

<body>
  <div id='container'>
    <svg id="svg" height=200 width=90%></svg>
  </div>
  <script src="https://d3js.org/d3.v6.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- <script src="app.js" type="text/javascript"></script> -->
  <script src="data.js" type="text/javascript"></script>

</body>

</html>

<script>

  var d3 = d3;


var username = (window.prompt("Enter your username: "))
  var name = username.toLowerCase().replace(/\s/g, '').replace('-', '_');

  const margin = 40;
  // window.onresize = windowSize;
  var width = (window.innerWidth * 0.8) - 2 * margin;
  const height = 800 - 2 * margin

  var svg = d3.select('svg')
  var svgContainer = d3.select('#container')


  if(window[name] == undefined){
    alert("This username does not exist! Please try again.");
    window.location.reload();
  }

  var dataset = window[name].sort(function(a,b) {
    return a.date - b.date;
  })

  window.onresize = function(event) {
  // update your variables
      width = (window.innerWidth * 0.8) - 2 * margin;
      d3.selectAll("svg > *").remove(); 
      graph();
  };
  
  function graph() {
  //circle chart
  var pie = d3.pie()
  var circ = pie([1, 1, 1, 1])
  var arcOut = d3.arc()
    .innerRadius(30)
    .outerRadius(60)

  var arcIn = d3.arc()
    .innerRadius(5)
    .outerRadius(30)

  var colorScaleOut = ["#B459DE", "#61ECDB", "#3372D2", "#FD3A3E"]
  var colorScaleIn = ["#E0BCF0", "#B6F6EE", "#B0C8ED", "#FED2D2"]

  //return colors to normal function - sharon
  function returnColors() {
    d3.selectAll(".purple").attr("fill", "#B459DE")
    d3.selectAll(".teal").attr("fill", "#61ECDB")
    d3.selectAll(".blue").attr("fill", "#3372D2")
    d3.selectAll(".red").attr("fill", "#FD3A3E")
    d3.selectAll(".lightPurple").attr("fill", "#E0BCF0")
    d3.selectAll(".lightTeal").attr("fill", "#B6F6EE")
    d3.selectAll(".lightBlue").attr("fill", "#B0C8ED")
    d3.selectAll(".lightRed").attr("fill", "#FED2D2")
    d3.selectAll(".white").attr("fill", "white")
  }
  
  function mouseout() {
    if (!isClicked){
      d3.select(this).attr("opacity", 1)
      returnColors()
    }
  }
  
  function reset() {
     returnColors()
     d3.select(this).attr("fill", "black")
        d3.selectAll(".quadrant1,.quadrant2,.quadrant3,.quadrant4,.redLegend,.lightRedLegend,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 1)
   }
  
  //only show certain colors on hover/click - sharon
  function showRed() {
    d3.selectAll(".purple,.teal,.blue,.lightPurple,.lightTeal,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showPurple() {
    d3.selectAll(".teal,.blue,.red,.lightPurple,.lightTeal,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showTeal(){
    d3.selectAll(".purple,.blue,.red,.lightPurple,.lightTeal,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showBlue(){
    d3.selectAll(".purple,.teal,.red,.lightPurple,.lightTeal,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showLightRed() {
    d3.selectAll(".purple,.teal,.blue,.red,.lightPurple,.lightTeal,.lightBlue,.white")
      .attr("fill", "#000000")
  }
  
  function showLightPurple() {
    d3.selectAll(".purple,.teal,.blue,.red,.lightTeal,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showLightTeal(){
    d3.selectAll(".purple,.teal,.blue,.red,.lightPurple,.lightBlue,.lightRed,.white")
      .attr("fill", "#000000")
  }
  
  function showLightBlue(){
    d3.selectAll(".purple,.teal,.blue,.red,.lightPurple,.lightTeal,.lightRed,.white")
      .attr("fill", "#000000")
  }

  var chart = svg.append("g")

  var legend = chart.append("g")

  legend.append("circle")
    .attr("cx", 100)
    .attr("cy", 200)
    .attr("r", 5)
    .attr("fill", "white")

  legend.selectAll("path")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,200)")
    .attr("d", arcIn)
    .attr("fill", function (d) {
      return colorScaleIn[d.index];
    })

  legend.selectAll("path2")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,200)")
    .attr("d", arcOut)
    .attr("fill", function (d) {
      return colorScaleOut[d.index];
    })

  //legend descriptions
  var tgrp = legend.append("g")
  tgrp.append("text")
    .attr("x", 0)
    .attr("y", 85)
    .attr("class", "title")
    .text("Mood Waves")

  tgrp.append("text")
    .attr("x", width + 50)
    .attr("y", 85)
    .attr("text-align", "right")
    .attr("class", "subheading")
    .text("Welcome, " + username) 

  tgrp.append("text")
    .attr("x", 0)
    .attr("y", 115)
    .attr("class", "subbody")
    .text("Please interact with the graph and legend below to explore your music and mood data.")

  //red legend
  tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 300)
      .attr("width", 30)
      .attr("height", 30)
      .attr("fill", "#FD3A3E")
      .attr("class","redLegend")
      .on("mouseover", function() { 
        if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showRed()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() { 
        if(!isClicked){
          isClicked = true; d3.selectAll(".quadrant2,.quadrant3,.quadrant4,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
          d3.select(this).attr("opacity", 1)
          showRed() 
        }
      })
  
  //light red legend
  tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 315)
      .attr("width", 30)
      .attr("height", 15)
      .attr("fill", "#FED2D2")
      .attr("class","lightRedLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showLightRed()
          }
      })
      .on("mouseout",mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant2,.quadrant3,.quadrant4,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showLightRed()
          }
      })
  
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 310)
    .attr("class", "quadrant1")
    .text("tense, nervous,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 335)
    .attr("class", "quadrant1")
    .text("stressed, upset")

  //purple legend
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 375)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#B459DE")
    .attr("class","purpleLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showPurple()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant1,.quadrant3,.quadrant4,.redLegend,.lightRedLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showPurple()
          }
      })
  
    //light purple legend
    tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 390)
      .attr("width", 30)
      .attr("height", 15)
      .attr("fill", "#E0BCF0")
      .attr("class","lightPurpleLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showLightPurple()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant1,.quadrant3,.quadrant4,.redLegend,.lightRedLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showLightPurple()
          }
      })
  
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 385)
    .attr("class", "quadrant2")
    .text("alert, excited,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 410)
    .attr("class", "quadrant2")
    .text("elated, happy")

  //teal legend
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 450)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#61ECDB")
    .attr("class","tealLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showTeal()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
          isClicked = true
            d3.selectAll(".quadrant1,.quadrant2,.quadrant4,.purpleLegend,.lightPurpleLegend,.redLegend,.lightRedLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showTeal()
          }
      })
  
    //light teal legend
    tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 465)
      .attr("width", 30)
      .attr("height", 15)
      .attr("fill", "#B6F6EE")
      .attr("class","lightTealLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showLightTeal()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant1,.quadrant2,.quadrant4,.purpleLegend,.lightPurpleLegend,.redLegend,.lightRedLegend,.blueLegend,.lightBlueLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showLightTeal()
          }
      })
  
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 460)
    .attr("class", "quadrant3")
    .text("content, serene,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 485)
    .attr("class", "quadrant3")
    .text("relaxed, calm")

  //blue legend
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 525)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#3372D2")
    .attr("class","blueLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showBlue()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant1,.quadrant2,.quadrant3,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.redLegend,.lightRedLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showBlue()
          }
      })
  
      //light blue legend
      tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 540)
      .attr("width", 30)
      .attr("height", 15)
      .attr("fill", "#B0C8ED")
      .attr("class","lightBlueLegend")
      .on("mouseover", function() { 
          if(!isClicked){
            d3.select(this).attr("opacity", 0.5)
            showLightBlue()
          }
      })
      .on("mouseout", mouseout)
      .on("click", function() {
          if(!isClicked){
            isClicked = true
            d3.selectAll(".quadrant1,.quadrant2,.quadrant3,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.redLegend,.lightRedLegend").attr("opacity", 0.2)
            d3.select(this).attr("opacity", 1)
            showLightBlue()
          }
      })
  
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 535)
    .attr("class", "quadrant4")
    .text("tired, bored,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 560)
    .attr("class", "quadrant4")
    .text("depressed, sad")

  //reset button
  tgrp.append("rect")
      .attr("x", 0)
      .attr("y", 600)
      .attr("width", 30)
      .attr("height", 30)
      .attr("fill", "#000000")
      .attr("class", "button")
      .text("reset")
      .on("click", function(){
        returnColors()
       d3.selectAll(".quadrant1,.quadrant2,.quadrant3,.quadrant4,.redLegend,.lightRedLegend,.purpleLegend,.lightPurpleLegend,.tealLegend,.lightTealLegend,.blueLegend,.lightBlueLegend").attr("opacity", 1)
      isClicked = false
      })
      .on("mouseover", function() { 
            d3.select(this).attr("opacity", 0.5)
      })
      .on("mouseout", function() { 
            d3.select(this).attr("opacity", 1)
      })
  
  var x = d3.scaleBand()
    .domain(d3.range(dataset.length))
    .range([margin + 200, width - (margin - 50)])
    .padding(0.1)

  var y = d3.scaleLinear()
    .domain([0, d3.max(dataset, d => d.frequency)]).nice()
    .range([height - margin, margin + 40])

  var xAxis = g => g
    .attr("transform", `translate(0,${height - margin})`)
    .attr("color", "white")
    .call(d3.axisBottom(x).tickFormat(i => d3.timeFormat('%B')(new Date(dataset[i].date))).tickSizeOuter(0))

  var bars = chart.append('g')

  bars.selectAll("bars")
    .data(dataset)
    .enter()
    .append("rect")
    .join("rect")
    .attr("fill", function (d) {
      if (d.quadrant == 1)
        return "#B459DE";
      if (d.quadrant == 2)
        return "#61ECDB";
      if (d.quadrant == 3)
        return "#3372D2";
      if (d.quadrant == 4)
        return "#FD3A3E";
      if (d.quadrant == 5)
        return "#E0BCF0";
      if (d.quadrant == 6)
        return "#B6F6EE";
      if (d.quadrant == 7)
        return "#B0C8ED";
      if (d.quadrant == 8)
        return "#FED2D2";
      if (d.quadrant == 9)
        return "white";
    })
    .attr("class", function(d) {
      if(d.quadrant == 1)
        return "purple";
      if(d.quadrant == 2)
        return "teal";
      if(d.quadrant == 3)
        return "blue";
      if(d.quadrant == 4)
        return "red";
      if(d.quadrant == 5)
        return "lightPurple";
      if(d.quadrant == 6)
        return "lightTeal";
      if(d.quadrant == 7)
        return "lightBlue";
      if(d.quadrant == 8)
        return "lightRed";
      if(d.quadrant == 9)
        return "white";
      })
    .attr("x", (d, i) => x(i))
    .attr("y", d => ((y(d.frequency * 2) + height) / 5) + 100)
    .attr("height", d => (y(0) - y(d.frequency)) * 0.8)
    .attr("width", x.bandwidth() + 1)

    //hover capabilities
    .on("mouseover", function (d, i) {
      d3.select(this)
        .attr("opacity", "25%")

      var tooltip = bars.append("g")
          .attr("id", "tooltip")

         var date = new Date(i.date)

          //details
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 310)
            .attr("class", "heading")
            .text(`${date.toLocaleString('default', { month: 'short' })}` + " " + `${date.getDate()}` + ", " + `${date.getFullYear()}`)
          tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 335)
            .attr("class", "subbody")
            .text("You listened to " + `${i.frequency}` + " songs.")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 370)
            .attr("class", "subheading")
            .text("top songs")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 390)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[0].name.length <= 35) {
                return `${i.topsongs[0].name}`;
              } else {
                return `${i.topsongs[0].name}`.slice(0,35) + "...";
              }})
         tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 405)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[0].singer.length <= 35) {
                return `${i.topsongs[0].singer}`;
              } else {
                return `${i.topsongs[0].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 425)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[1].name.length < 35) {
                return `${i.topsongs[1].name}`;
              } else {
                return `${i.topsongs[1].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 440)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[1].singer.length <= 35) {
                return `${i.topsongs[1].singer}`;
              } else {
                return `${i.topsongs[1].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 460)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[2].name.length < 35) {
                return `${i.topsongs[2].name}`;
              } else {
                return `${i.topsongs[2].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 475)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[2].singer.length <= 35) {
                return `${i.topsongs[2].singer}`;
              } else {
                return `${i.topsongs[2].singer}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 495)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[3].name.length < 35) {
                return `${i.topsongs[3].name}`;
              } else {
                return `${i.topsongs[3].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 510)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[3].singer.length <= 35) {
                return `${i.topsongs[3].singer}`;
              } else {
                return `${i.topsongs[3].singer}`.slice(0,35) + "...";
              }})
             tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 530)
            .attr("class", "subtitle")
            .text(function() {
              if(i.topsongs[4].name.length < 35) {
                return `${i.topsongs[4].name}`;
              } else {
                return `${i.topsongs[4].name}`.slice(0,35) + "...";
              }})
              tooltip.append("text")
            .attr("x", width+ 50)
            .attr("y", 545)
            .attr("class", "subbody")
            .text(function() {
              if(i.topsongs[4].singer.length <= 35) {
                return `${i.topsongs[4].singer}`;
              } else {
                return `${i.topsongs[4].singer}`.slice(0,35) + "...";
            }})
            tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 580)
            .attr("class", "subheading")
            .text("mood")
            tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 600)
            .attr("class", "subbody")
            .text(function() {
               if(i.keywords == null) {
                return "____";
              } else if(i.keywords.length <= 40) {
                return `${i.keywords}`;
              } else {
                return `${i.keywords}`.slice(0,40) + "...";
              }})
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 640)
            .attr("class", "subheading")
            .text("reflections")
          tooltip.append("text")
            .attr("x", width + 50)
            .attr("y", 660)
            .attr("class", "subbody")
            .text(function() {
              if(i.reflections == null) {
                return "____";
              } else {
                return `${i.reflections}`;
            }})
            .attr("dy", 0)
            .call(wrap, x.bandwidth());
  			 })
  			.on("mouseout", function(d) {
  			  d3.select(this)
  			  .transition().duration(250)
  			  .attr("opacity", "100%");
  			  d3.select("#tooltip").remove();
  			});

          //x axis formatting
          var temp = []
          var axis = chart.append('g')

          axis.append("g")
            .call(xAxis)
            .selectAll(".tick text")
            .attr("fill", "white")
            .data(dataset)
            .each(function (d) {
              var date = new Date(d.date)
              if (temp[date.toLocaleString('default', { month: 'long' })] == undefined) {
                temp[date.toLocaleString('default', { month: 'long' })] = 1;
                return date.toLocaleString('default', { month: 'long' });
              } else {
                return d3.select(this).remove();
              }
            })
      }

  graph()

  function wrap(text) {
    text.each(function () {
      var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        x = text.attr("x")
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > 250) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }

  function classifyQuadrant(x, y) {
    if (x >= 0 && y > 0) {
      if (innerQuad(x, y)) {
        return 5;
      } else {
        return 1;
      }
    }
    else if (x > 0 && y <= 0) {
      if (innerQuad(x, y)) {
        return 6;
      } else {
        return 2;
      }
    }
    else if (x <= 0 && y < 0) {
      if (innerQuad(x, y)) {
        return 7;
      } else {
        return 3;
      }
    }
    else if (x < 0 && y >= 0) {
      if (innerQuad(x, y)) {
        return 8;
      } else {
        return 4;
      }
    }
    else {
      return 9;
    }
  }

  function innerQuad(x, y) {
    return Math.sqrt(x * x + y * y) < 3;
  }

</script>
