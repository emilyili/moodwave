<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MoodWaves</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Open+Sans" rel="stylesheet">
</head>

<body>
  <div id='layout'>
    <div id='container'>
      <svg id="svg" height=200 width=450></svg>
    </div>
  </div>

  <script src="https://d3js.org/d3.v6.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- <script src="app.js" type="text/javascript"></script> -->
  <script src="data.js" type="text/javascript"></script>

</body>
</html>

<script>
  // 	const width = 1000;
  // 	const height = 600;
  // 	const margin = ({top: 30, right: -100, bottom: -50, left: 250})

var d3 = d3;

var name = window.prompt("Enter your username: ");
// alert("Your name is " + name);

  const margin = 40;
  const width = 1200 - 2 * margin
  const height = 700 - 2 * margin

  var svg = d3.select('svg')
  var svgContainer = d3.select('#container')

  // console.log(name)
  // console.log(window[name])

    var dataset = window[name].sort(function(a,b) {
              return a.date - b.date;
            })

  //circle chart
  var pie = d3.pie()
  var circ = pie([1, 1, 1, 1])
  var arcOut = d3.arc()
    .innerRadius(25)
    .outerRadius(50)

  var arcIn = d3.arc()
    .innerRadius(3)
    .outerRadius(25)

  var colorScaleOut = ["#B459DE", "#61ECDB", "#3372D2", "#FD3A3E"]
  var colorScaleIn = ["#E0BCF0", "#B6F6EE", "#B0C8ED", "#FED2D2"]

  var chart = svg.append("g")

  var legend = chart.append("g")

  legend.append("circle")
    .attr("cx", 100)
    .attr("cy", 145)
    .attr("r", 3)
    .attr("fill", "white")

  legend.selectAll("path")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,145)")
    .attr("d", arcIn)
    .attr("fill", function (d) {
      return colorScaleIn[d.index];
    })
 
  legend.selectAll("path2")
    .data(circ)
    .enter()
    .append("path")
    .attr("transform", "translate(100,145)")
    .attr("d", arcOut)
    .attr("fill", function (d) {
      return colorScaleOut[d.index];
    })

  //legend descriptions
  var tgrp = legend.append("g")
  tgrp.append("text")
    .attr("x", 25)
    .attr("y", 50)
    .attr("class", "title")
    .text("Mood Waves")
  tgrp.append("text")
    .attr("x", 250)
    .attr("y", 50)
    .attr("class", "title")
    .text("Welcome, " + name)  
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 240)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#FD3A3E")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 250)
    .attr("class", "heading")
    .text("tense, nervous,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 270)
    .attr("class", "heading")
    .text("stressed, upset")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 300)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#B459DE")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 310)
    .attr("class", "heading")
    .text("alert, excited,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 330)
    .attr("class", "heading")
    .text("elated, happy")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 360)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#61ECDB")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 370)
    .attr("class", "heading")
    .text("content, serene,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 390)
    .attr("class", "heading")
    .text("relaxed, calm")
  tgrp.append("rect")
    .attr("x", 0)
    .attr("y", 420)
    .attr("width", 30)
    .attr("height", 30)
    .attr("fill", "#3372D2")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 430)
    .attr("class", "heading")
    .text("tired, bored,")
  tgrp.append("text")
    .attr("x", 60)
    .attr("y", 450)
    .attr("class", "heading")
    .text("depressed, sad")

  //     const chart = svg.append('g')
  //       .attr('transform', `translate(${margin}, ${margin})`);

  //     const xScale = d3.scaleBand()
  //       .range([0, width])
  //       .domain(sample.map((s) => s.language))
  //       .padding(0.4)

  //     const yScale = d3.scaleLinear()
  //       .range([height, 0])
  //       .domain([0, 100]);

  //     vertical grid lines
  //     const makeXLines = () => d3.axisBottom()
  //       .scale(xScale)

  //     const makeYLines = () => d3.axisLeft()
  //       .scale(yScale)

  //     chart.append('g')
  //       .attr('transform', `translate(0, ${height})`)
  //       .call(d3.axisBottom(xScale));

  //     chart.append('g')
  //       .call(d3.axisLeft(yScale));

  //     // vertical grid lines
  //     // chart.append('g')
  //     //   .attr('class', 'grid')
  //     //   .attr('transform', `translate(0, ${height})`)
  //     //   .call(makeXLines()
  //     //     .tickSize(-height, 0, 0)
  //     //     .tickFormat('')
  //     //   )

  //     chart.append('g')
  //       .attr('class', 'grid')
  //       .call(makeYLines()
  //         .tickSize(-width, 0, 0)
  //         .tickFormat('')
  //       )

  //     const barGroups = chart.selectAll()
  //       .data(sample)
  //       .enter()
  //       .append('g')

  //     barGroups
  //       .append('rect')
  //       .attr('class', 'bar')
  //       .attr('x', (g) => xScale(g.language))
  //       .attr('y', (g) => yScale(g.value))
  //       .attr('height', (g) => height - yScale(g.value))
  //       .attr('width', xScale.bandwidth())
  //       .on('mouseenter', function (actual, i) {
  //         d3.selectAll('.value')
  //           .attr('opacity', 0)

  //         d3.select(this)
  //           .transition()
  //           .duration(300)
  //           .attr('opacity', 0.6)
  //           .attr('x', (a) => xScale(a.language) - 5)
  //           .attr('width', xScale.bandwidth() + 10)

  //         const y = yScale(actual.value)

  //         line = chart.append('line')
  //           .attr('id', 'limit')
  //           .attr('x1', 0)
  //           .attr('y1', y)
  //           .attr('x2', width)
  //           .attr('y2', y)

  //         barGroups.append('text')
  //           .attr('class', 'divergence')
  //           .attr('x', (a) => xScale(a.language) + xScale.bandwidth() / 2)
  //           .attr('y', (a) => yScale(a.value) + 30)
  //           .attr('fill', 'white')
  //           .attr('text-anchor', 'middle')
  //           .text((a, idx) => {
  //             const divergence = (a.value - actual.value).toFixed(1)

  //             let text = ''
  //             if (divergence > 0) text += '+'
  //             text += `${divergence}%`

  //             return idx !== i ? text : '';
  //           })

  //       })
  //       .on('mouseleave', function () {
  //         d3.selectAll('.value')
  //           .attr('opacity', 1)

  //         d3.select(this)
  //           .transition()
  //           .duration(300)
  //           .attr('opacity', 1)
  //           .attr('x', (a) => xScale(a.language))
  //           .attr('width', xScale.bandwidth())

  //         chart.selectAll('#limit').remove()
  //         chart.selectAll('.divergence').remove()
  //       })

  //     barGroups 
  //       .append('text')
  //       .attr('class', 'value')
  //       .attr('x', (a) => xScale(a.language) + xScale.bandwidth() / 2)
  //       .attr('y', (a) => yScale(a.value) + 30)
  //       .attr('text-anchor', 'middle')
  //       .text((a) => `${a.value}%`)

  //     svg
  //       .append('text')
  //       .attr('class', 'label')
  //       .attr('x', -(height / 2) - margin)
  //       .attr('y', margin / 2.4)
  //       .attr('transform', 'rotate(-90)')
  //       .attr('text-anchor', 'middle')
  //       .text('Love meter (%)')

  //     svg.append('text')
  //       .attr('class', 'label')
  //       .attr('x', width / 2 + margin)
  //       .attr('y', height + margin * 1.7)
  //       .attr('text-anchor', 'middle')
  //       .text('Languages')

  //     svg.append('text')
  //       .attr('class', 'title')
  //       .attr('x', width / 2 + margin)
  //       .attr('y', 40)
  //       .attr('text-anchor', 'middle')
  //       .text('Most loved programming languages in 2018')

  //     svg.append('text')
  //       .attr('class', 'source')
  //       .attr('x', width - margin / 2)
  //       .attr('y', height + margin * 1.7)
  //       .attr('text-anchor', 'start')
  //       .text('Source: Stack Overflow, 2018')

  var x = d3.scaleBand()
    .domain(d3.range(dataset.length))
    .range([margin + 225, width - margin + 100])
    .padding(0.1)

  var y = d3.scaleLinear()
    .domain([0, d3.max(dataset, d => d.frequency)]).nice()
    .range([height - margin, margin])

    var xAxis = g => g
    .attr("transform", `translate(0,${height - margin})`)
    .attr("color", "white")
    .call(d3.axisBottom(x).tickFormat(i => d3.timeFormat('%B')(new Date(dataset[i].date))).tickSizeOuter(0))

  var bars = chart.append('g')

    bars.selectAll("bars")
      .data(dataset)
      .enter()
      .append("rect")
      .join("rect")
      // .attr("fill", "pink")
    .attr("fill", function (d) {
      if (d.quadrant == 1)
        return "#B459DE";
      if (d.quadrant == 2)
        return "#61ECDB";
      if (d.quadrant == 3)
        return "#3372D2";
      if (d.quadrant == 4)
        return "#FD3A3E";
      if (d.quadrant == 5)
        return "#E0BCF0";
      if (d.quadrant == 6)
        return "#B6F6EE";
      if (d.quadrant == 7)
        return "#B0C8ED";
      if (d.quadrant == 8)
        return "#FED2D2";
      if (d.quadrant == 9)
        return "white";
    })
    .attr("x", (d, i) => x(i))
    .attr("y", d => ((y(d.frequency * 2) + height) / 5) + 100)
    .attr("height", d => (y(0) - y(d.frequency)) * 0.8)
    .attr("width", x.bandwidth() + 1)

      //hover capabilities
    .on("mouseover", function(d, i) {
  	  d3.select(this)
          .attr("opacity", "25%")

      var tooltip = bars.append("g")
       // bars.append("g")
          .attr("id", "tooltip")

         tooltip.append("rect")
            .attr("width", "249px")
            .attr("height", "90%")
            .attr("fill", "#34383A")

          //title
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 50)
            .attr("class", "title")
            .text("Mood Waves")

           //circle chart
           tooltip.append("circle")
              .attr("cx", 100)
              .attr("cy", 145)
              .attr("r", 3)
              .attr("fill", "white")

              tooltip.selectAll("path3")
              .data(circ)
              .enter()
              .append("path")
              .attr("transform", "translate(100,145)")
              .attr("d", arcIn)
              .attr("fill", function(d) {
                return colorScaleIn[d.index];
              })
              tooltip.selectAll("path4")
              .data(circ)
              .enter()
              .append("path")
              .attr("transform", "translate(100,145)")
              .attr("d", arcOut)
              .attr("fill", function(d) {
                return colorScaleOut[d.index];
              })

         var date = new Date(i.date)

          //details
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 250)
            .attr("class", "heading")
            .text(`${date.toLocaleString('default', { month: 'short' })}` + " " + `${date.getDate()}` + ", " + `${date.getFullYear()}`)
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 270)
            .attr("class", "body")
            .text("You listened to " + `${i.frequency}` + " songs.")
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 300)
            .attr("class", "heading")
            .text("top songs")
          tooltip.append("text")
            .attr("x", 65)
            .attr("y", 325)
            .attr("class", "heading")
            .text(function() {
              if(i.topsongs[0].name.length <= 25) {
                return `${i.topsongs[0].name}`;
              } else {
                return `${i.topsongs[0].name}`.slice(0,22) + "...";
              }})
         tooltip.append("text")
            .attr("x", 65)
            .attr("y", 340)
            .attr("class", "body")
            .text(function() {
              if(i.topsongs[0].singer.length <= 25) {
                return `${i.topsongs[0].singer}`;
              } else {
                return `${i.topsongs[0].singer}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 365)
            .attr("class", "heading")
            .text(function() {
              if(i.topsongs[1].name.length < 25) {
                return `${i.topsongs[1].name}`;
              } else {
                return `${i.topsongs[1].name}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 380)
            .attr("class", "body")
            .text(function() {
              if(i.topsongs[1].singer.length <= 25) {
                return `${i.topsongs[1].singer}`;
              } else {
                return `${i.topsongs[1].singer}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 405)
            .attr("class", "heading")
            .text(function() {
              if(i.topsongs[2].name.length < 25) {
                return `${i.topsongs[2].name}`;
              } else {
                return `${i.topsongs[2].name}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 420)
            .attr("class", "body")
            .text(function() {
              if(i.topsongs[2].singer.length <= 25) {
                return `${i.topsongs[2].singer}`;
              } else {
                return `${i.topsongs[2].singer}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 445)
            .attr("class", "heading")
            .text(function() {
              if(i.topsongs[3].name.length < 25) {
                return `${i.topsongs[3].name}`;
              } else {
                return `${i.topsongs[3].name}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 460)
            .attr("class", "body")
            .text(function() {
              if(i.topsongs[3].singer.length <= 25) {
                return `${i.topsongs[3].singer}`;
              } else {
                return `${i.topsongs[3].singer}`.slice(0,22) + "...";
              }})
             tooltip.append("text")
            .attr("x", 65)
            .attr("y", 485)
            .attr("class", "heading")
            .text(function() {
              if(i.topsongs[4].name.length < 25) {
                return `${i.topsongs[4].name}`;
              } else {
                return `${i.topsongs[4].name}`.slice(0,22) + "...";
              }})
              tooltip.append("text")
            .attr("x", 65)
            .attr("y", 500)
            .attr("class", "body")
            .text(function() {
              if(i.topsongs[4].singer.length <= 25) {
                return `${i.topsongs[4].singer}`;
              } else {
                return `${i.topsongs[4].singer}`.slice(0,22) + "...";
            }})
            tooltip.append("text")
            .attr("x", 25)
            .attr("y", 530)
            .attr("class", "heading")
            .text("mood")
            tooltip.append("text")
            .attr("x", 25)
            .attr("y", 550)
            .attr("class", "body")
            .text(function() {
               if(i.keywords == null) {
                return "____";
              } else if(i.keywords.length <= 30) {
                return `${i.keywords}`;
              } else {
                return `${i.keywords}`.slice(0,30) + "...";
              }})
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 580)
            .attr("class", "heading")
            .text("reflections")
          tooltip.append("text")
            .attr("x", 25)
            .attr("y", 600)
            .attr("class", "body")
            .text(function() {
              if(i.reflections == null) {
                return "____";
              } else {
                return `${i.reflections}`;
            }})
            .attr("dy", 0)
            .call(wrap, x.bandwidth());
  			 })
  			.on("mouseout", function(d) {
  			  d3.select(this)
  			  .transition().duration(250)
  			  .attr("opacity", "100%");
  			  d3.select("#tooltip").remove();
  			});

  //x axis formatting
  var temp = []
  var axis = chart.append('g')

  axis.append("g")
    .call(xAxis)
    .selectAll(".tick text")
    .attr("fill", "white")
    .data(dataset)
    .each(function (d) {
      var date = new Date(d.date)
      if (temp[date.toLocaleString('default', { month: 'long' })] == undefined) {
        temp[date.toLocaleString('default', { month: 'long' })] = 1;
        return date.toLocaleString('default', { month: 'long' });
      } else {
        return d3.select(this).remove();
      }
    })

  // var xAxis = g => g
  //   .attr("transform", `translate(0,${height - margin})`)
  //   .attr("color", "white")
  //   .call(d3.axisBottom(x).tickFormat(i => d3.timeFormat('%B')(new Date(dailyData[i].date))).tickSizeOuter(0))

  function wrap(text) {
    text.each(function () {
      var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 25).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > 200) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", 25).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }

  function classifyQuadrant(x, y) {
    if (x >= 0 && y > 0) {
      if (innerQuad(x, y)) {
        return 5;
      } else {
        return 1;
      }
    }
    else if (x > 0 && y <= 0) {
      if (innerQuad(x, y)) {
        return 6;
      } else {
        return 2;
      }
    }
    else if (x <= 0 && y < 0) {
      if (innerQuad(x, y)) {
        return 7;
      } else {
        return 3;
      }
    }
    else if (x < 0 && y >= 0) {
      if (innerQuad(x, y)) {
        return 8;
      } else {
        return 4;
      }
    }
    else {
      return 9;
    }
  }

  function innerQuad(x, y) {
    return Math.sqrt(x * x + y * y) < 3;
  }

</script>
